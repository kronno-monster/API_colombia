<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Departamentos y Sitios Turísticos</title>
  <link rel="stylesheet" href="styles.css">
 
</head>
<body>
  
  <nav class="top-nav" aria-label="Navegación principal">
    <a href="#top" onclick="window.scrollTo({top:0,behavior:'smooth'}); return false;">Inicio</a>
    <a href="#departments-panel">Departamentos</a>
    <a href="#sites-panel">Sitios turísticos</a>
  </nav>

  <header class="site-header" id="top">
    <h1>10 Departamentos — 10 Sitios Turísticos</h1>
    <p class="subtitle"></p>
  </header>

  
  <main class="main">

    <section class="panel" id="departments-panel" tabindex="0">
      <h2 class="panel-title">Departamentos</h2>
      <div class="carousel">
        <div class="left cards" id="dept-cards">
       
        </div>

        <div class="right viewer">
          <div class="viewer-inner">
            <h3 id="dept-name">Departamento</h3>
            <p class="meta"><strong>Capital:</strong> <span id="dept-capital"></span> · <strong>Región:</strong> <span id="dept-region"></span></p>
            <p id="dept-desc" class="desc"></p>
            <div class="viewer-controls">
             
              <button type="button" class="btn small" id="dept-prev" aria-label="Anterior departamento">‹</button>
              <button type="button" class="btn small" id="dept-next" aria-label="Siguiente departamento">›</button>
            </div>
          </div>
          <div class="viewer-image">
            <img id="dept-img" src="images/department1.jpg" alt="Imagen del departamento">
          </div>
        </div>
      </div>
    </section>

    <!-- SITIOS TURÍSTICOS -->
    <!-- Añadido tabindex -->
    <section class="panel" id="sites-panel" tabindex="0">
      <h2 class="panel-title">Sitios Turísticos</h2>
      <div class="carousel">
        <div class="left cards" id="site-cards">
          <!-- Fichas generadas por JS -->
        </div>

        <div class="right viewer">
          <div class="viewer-inner">
            <h3 id="site-name">Sitio turístico</h3>
            <p class="meta"><strong>Departamento:</strong> <span id="site-dept"></span> · <strong>Ciudad:</strong> <span id="site-city"></span></p>
            <p id="site-desc" class="desc"></p>
            <div class="viewer-controls">
              <!-- Añadido type="button" -->
              <button type="button" class="btn small" id="site-prev" aria-label="Anterior sitio">‹</button>
              <button type="button" class="btn small" id="site-next" aria-label="Siguiente sitio">›</button>
            </div>
          </div>
          <div class="viewer-image">
            <img id="site-img" src="images/site1.jpg" alt="Imagen del sitio turístico">
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <small>Generado automáticamente — reemplaza imágenes y textos como necesites.</small>
  </footer>

  <script>
    // helpers para extraer texto cuando la API devuelve objetos/arrays
    function getStringField(v){
      if (v == null) return '';
      if (typeof v === 'string') return v.trim();
      if (typeof v === 'number') return String(v);
      if (Array.isArray(v) && v.length) return getStringField(v[0]);
      if (typeof v === 'object'){
        const keys = ['es','es_CO','en','en_US','name','nombre','title','titulo','label','value','text'];
        for (const k of keys) if (v[k]) return getStringField(v[k]);
        for (const k in v){
          if (typeof v[k] === 'string') return v[k].trim();
          if (typeof v[k] === 'object'){
            const s = getStringField(v[k]);
            if (s) return s;
          }
        }
      }
      return '';
    }

    // antiguo pickImage -> reemplazado por getImageUrl más robusto
    function getImageUrl(obj){
      if (!obj) return '';
      // si es string
      if (typeof obj === 'string') {
        const s = obj.trim();
        if (!s) return '';
        return s;
      }
      // si es array, intentar extraer del primer elemento recursivamente
      if (Array.isArray(obj) && obj.length) return getImageUrl(obj[0]);

      // si es objeto, buscar propiedades comunes
      if (typeof obj === 'object') {
        const candidates = ['url', 'src', 'imageUrl', 'imagen', 'photo', 'path', 'href', 'link'];
        for (const k of candidates){
          if (obj[k]) {
            const v = getImageUrl(obj[k]);
            if (v) return v;
          }
        }
        // campos anidados (ej. { photo: { url: '...' } })
        for (const k in obj){
          if (obj[k]) {
            const v = getImageUrl(obj[k]);
            if (v) return v;
          }
        }
      }
      return '';
    }

    // lookup corto (sin cambios)
    const departmentLookup = {
      "amazonas": { capital: "Leticia", region: "Amazonas" },
      "antioquia": { capital: "Medellín", region: "Antioquia" },
      "arauca": { capital: "Arauca", region: "Orinoquía" },
      "atlántico": { capital: "Barranquilla", region: "Caribe" },
      "bolívar": { capital: "Cartagena", region: "Caribe" },
      "boyacá": { capital: "Tunja", region: "Andina" },
      "caldas": { capital: "Manizales", region: "Andina" },
      "caquetá": { capital: "Florencia", region: "Amazonas" },
      "casanare": { capital: "Yopal", region: "Orinoquía" },
      "cauca": { capital: "Popayán", region: "Pacífico" },
      "cesar": { capital: "Valledupar", region: "Caribe" },
      "chocó": { capital: "Quibdó", region: "Pacífico" },
      "córdoba": { capital: "Montería", region: "Caribe" },
      "cundinamarca": { capital: "Bogotá D.C.", region: "Andina" },
      "huila": { capital: "Neiva", region: "Andina" },
      "la guajira": { capital: "Riohacha", region: "Caribe" },
      "magdalena": { capital: "Santa Marta", region: "Caribe" },
      "meta": { capital: "Villavicencio", region: "Orinoquía" },
      "nariño": { capital: "Pasto", region: "Pacífico" },
      "norte de santander": { capital: "Cúcuta", region: "Andina" },
      "quindío": { capital: "Armenia", region: "Andina" },
      "risaralda": { capital: "Pereira", region: "Andina" },
      "santander": { capital: "Bucaramanga", region: "Andina" },
      "sucre": { capital: "Sincelejo", region: "Caribe" },
      "tolima": { capital: "Ibagué", region: "Andina" },
      "valle del cauca": { capital: "Cali", region: "Pacífico" },
      "san andrés y providencia": { capital: "San Andrés", region: "Insular" },
    };

    function normalizeName(n){ return String(n || '').trim().toLowerCase(); }

    // datos
    let departments = [];
    let sites = [];

    // Guardar también un id/código cuando exista para permitir matching por id
    async function fetchDepartments(){
      try {
        const res = await fetch('https://api-colombia.com/api/v1/Department');
        if (!res.ok) throw new Error('Network response was not ok');
        const payload = await res.json();
        const items = Array.isArray(payload) ? payload : (payload.data || []);
        departments = items.slice(0, 10).map((d, i) => {
          const name = getStringField(d.name) || getStringField(d.nombre) || `Departamento ${i+1}`;
          const id = d.id || d._id || d.code || d.codigo || d.department_id || '';
          let capital = getStringField(d.capital) || getStringField(d.capital_city) || '';
          let region = getStringField(d.region) || getStringField(d.region_name) || '';
          // obtener imagen desde distintos formatos que pueda devolver la API
          const imgFromApi = getImageUrl(d.image || d.photo || d.flag || d.media || d.images || d.photos || d.imagenes);
          const img = imgFromApi || `images/department${(i%10)+1}.jpg`;
          const lookup = departmentLookup[normalizeName(name)];
          if(lookup){
            if(!capital) capital = lookup.capital || '';
            if(!region) region = lookup.region || '';
          }
          return {
            id,
            name,
            capital: capital || '—',
            region: region || '—',
            description: getStringField(d.description) || getStringField(d.descripcion) || '',
            image: img
          };
        });
      } catch (err) {
        console.error('Error cargando departamentos:', err);
        departments = [];
      }
    }

    // Buscar departamento por id o por nombre parcial
    function findDeptByIdOrName(val){
      if(!val) return null;
      const v = String(val).trim().toLowerCase();
      // intentar por id/código
      for(const dep of departments){
        if(!dep) continue;
        if(dep.id && String(dep.id).toLowerCase() === v) return dep.name;
      }
      // intentar por nombre exacto/ parcial
      for(const dep of departments){
        const depName = normalizeName(dep.name);
        if(!depName) continue;
        if(depName === v || depName.includes(v) || v.includes(depName)) return dep.name;
      }
      return null;
    }

    async function fetchSites(){
      try {
        const res = await fetch('https://api-colombia.com/api/v1/TouristicAttraction');
        if (!res.ok) throw new Error('Network response was not ok');
        const payload = await res.json();
        const items = Array.isArray(payload) ? payload : (payload.data || []);
        sites = items.slice(0, 10).map((s, i) => {
          const name = getStringField(s.name) || getStringField(s.nombre) || `Sitio ${i+1}`;
          const city = getStringField(s.city) || getStringField(s.ciudad) || getStringField(s.municipality) || getStringField(s.municipio) || '';
          // obtener imagen desde distintos formatos que pueda devolver la API
          const imgFromApi = getImageUrl(s.image || s.photo || s.media || s.images || s.photos || s.imagenes);
          const img = imgFromApi || `images/site${(i%10)+1}.jpg`;
          const deptField = s.department || s.departmentName || s.departamento || s.department_id || s.idDepartment || s.departmentCode || '';
          const deptIdField = s.department_id || s.idDepartment || s.departmentId || s.department_code || '';
          return {
            raw: s,
            name,
            deptRaw: getStringField(deptField) || '',
            deptIdRaw: getStringField(deptIdField) || '',
            city: city || '—',
            description: getStringField(s.description) || getStringField(s.descripcion) || '',
            image: img
          };
        });

        // resolver departamentos (igual que antes)
        sites = sites.map((si) => {
          let resolved = '';
          if(si.deptIdRaw){
            resolved = findDeptByIdOrName(si.deptIdRaw);
          }
          if(!resolved && si.deptRaw){
            resolved = findDeptByIdOrName(si.deptRaw);
          }
          if(!resolved){
            const text = [getStringField(si.raw.name), getStringField(si.raw.nombre), getStringField(si.raw.description), getStringField(si.raw.descripcion)].filter(Boolean).join(' ').toLowerCase();
            if(text){
              for(const dep of departments){
                const depName = normalizeName(dep.name);
                if(depName && (text.includes(depName) || text.includes(depName.split(' ')[0]))) { resolved = dep.name; break; }
              }
            }
          }
          si.dept = resolved || si.deptRaw || '—';
          return si;
        });

      } catch (err) {
        console.error('Error cargando sitios turísticos:', err);
        sites = [];
      }
    }

    // Asegura que la ruta tenga carpeta images/ si el valor es solo un nombre de archivo
    function normalizeImagePath(p){
      if(!p) return '';
      p = String(p).trim();
      if(!p) return '';
      // si ya tiene protocolo o slash, devolver tal cual
      if (/^(https?:)?\/\//.test(p) || p.includes('/')) return p;
      return `images/${p}`;
    }

    // Asigna src a un <img> y aplica fallback en caso de error
    function setImageWithFallback(imgEl, src, fallback){
      if(!imgEl) return;
      const finalSrc = normalizeImagePath(src) || normalizeImagePath(fallback);
      imgEl.src = finalSrc;
      // remover listeners previos para evitar múltiples handlers
      imgEl.onerror = null;
      imgEl.addEventListener('error', function onErr(){
        imgEl.removeEventListener('error', onErr);
        imgEl.src = normalizeImagePath(fallback);
      });
    }

    // render + lógica (se mantienen funciones previas pero usando los campos corregidos)
    const deptCardsContainer = document.getElementById('dept-cards');
    const deptName = document.getElementById('dept-name');
    const deptCapital = document.getElementById('dept-capital');
    const deptRegion = document.getElementById('dept-region');
    const deptDesc = document.getElementById('dept-desc');
    const deptImg = document.getElementById('dept-img');
    const deptPrev = document.getElementById('dept-prev');
    const deptNext = document.getElementById('dept-next');

    const siteCardsContainer = document.getElementById('site-cards');
    const siteName = document.getElementById('site-name');
    const siteDept = document.getElementById('site-dept');
    const siteCity = document.getElementById('site-city');
    const siteDesc = document.getElementById('site-desc');
    const siteImg = document.getElementById('site-img');
    const sitePrev = document.getElementById('site-prev');
    const siteNext = document.getElementById('site-next');

    let currentDept = 0;
    let currentSite = 0;

    function renderDeptCards(){
      deptCardsContainer.innerHTML = '';
      departments.forEach((d,i)=>{
        const imgSrc = normalizeImagePath(d.image) || `images/department${(i%10)+1}.jpg`;
        const btn = document.createElement('button');
        btn.type='button'; btn.className='card'; btn.setAttribute('data-index',i);
        // construir elemento img y usar fallback
        btn.innerHTML = `<img class="card-img" src="${imgSrc}" alt="${d.name}"><div><strong>${d.name}</strong><span class="card-sub">${d.capital} · ${d.region}</span></div>`;
        // asegurar fallback si la imagen falla
        const tmpImg = btn.querySelector('.card-img');
        setImageWithFallback(tmpImg, d.image, `images/department${(i%10)+1}.jpg`);
        btn.addEventListener('click',()=> setDept(i));
        deptCardsContainer.appendChild(btn);
      });
    }

    function setDept(index){
      if(!departments.length) return;
      currentDept = (index + departments.length) % departments.length;
      const d = departments[currentDept];
      deptName.textContent = d.name;
      deptCapital.textContent = d.capital || '—';
      deptRegion.textContent = d.region || '—';
      deptDesc.textContent = d.description || '';
      // usar función para asignar imagen con fallback
      setImageWithFallback(deptImg, d.image, `images/department${(currentDept%10)+1}.jpg`);
      deptImg.alt = `Imagen de ${d.name}`;
      [...deptCardsContainer.children].forEach((c)=> {
        const match = Number(c.getAttribute('data-index'))===currentDept;
        c.classList.toggle('active', match);
        if(match) c.scrollIntoView({behavior:'smooth', block:'center'});
      });
    }
    deptPrev && deptPrev.addEventListener('click', ()=> setDept(currentDept-1));
    deptNext && deptNext.addEventListener('click', ()=> setDept(currentDept+1));

    // ===== sitios =====
    function renderSiteCards(){
      siteCardsContainer.innerHTML = '';
      sites.forEach((s,i)=>{
        const imgSrc = normalizeImagePath(s.image) || `images/site${(i%10)+1}.jpg`;
        const btn = document.createElement('button');
        btn.type='button'; btn.className='card'; btn.setAttribute('data-index',i);
        const deptText = s.dept || '—'; const cityText = s.city || '—';
        btn.innerHTML = `<img class="card-img" src="${imgSrc}" alt="${s.name}"><div><strong>${s.name}</strong><span class="card-sub">${deptText} · ${cityText}</span></div>`;
        const tmpImg = btn.querySelector('.card-img');
        setImageWithFallback(tmpImg, s.image, `images/site${(i%10)+1}.jpg`);
        btn.addEventListener('click', ()=> setSite(i));
        siteCardsContainer.appendChild(btn);
      });
    }

    function setSite(index){
      if(!sites.length) return;
      currentSite = (index + sites.length) % sites.length;
      const s = sites[currentSite];
      siteName.textContent = s.name;
      siteDept.textContent = s.dept || '—';
      siteCity.textContent = s.city || '—';
      siteDesc.textContent = s.description || '';
      setImageWithFallback(siteImg, s.image, `images/site${currentSite%10+1}.jpg`);
      siteImg.alt = `Imagen de ${s.name}`;
      [...siteCardsContainer.children].forEach((c)=> {
        const match = Number(c.getAttribute('data-index'))===currentSite;
        c.classList.toggle('active', match);
        if(match) c.scrollIntoView({behavior:'smooth', block:'center'});
      });
    }
    sitePrev && sitePrev.addEventListener('click', ()=> setSite(currentSite-1));
    siteNext && siteNext.addEventListener('click', ()=> setSite(currentSite+1));

    // inicializar datos y UI
    async function initData(){ await fetchDepartments(); await fetchSites(); renderDeptCards(); if(departments.length) setDept(0); renderSiteCards(); if(sites.length) setSite(0); }
    initData();

    // accesibilidad teclas
    document.getElementById('departments-panel').addEventListener('keydown', (e) => { if (e.key === 'ArrowLeft') setDept(currentDept - 1); if (e.key === 'ArrowRight') setDept(currentDept + 1); });
    document.getElementById('sites-panel').addEventListener('keydown', (e) => { if (e.key === 'ArrowLeft') setSite(currentSite - 1); if (e.key === 'ArrowRight') setSite(currentSite + 1); });
  </script>
</body>
</html>
